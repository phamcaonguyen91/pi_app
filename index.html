<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C·ªù T∆∞·ªõng 2D - Mobile Friendly</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        /* Thi·∫øt l·∫≠p font cho c√°c qu√¢n c·ªù b·∫±ng Unicode/Emoji, ƒë·∫£m b·∫£o hi·ªÉn th·ªã ƒë·∫πp v√† s·∫Øc n√©t */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            /* Thay ƒë·ªïi ƒë·ªÉ cƒÉn gi·ªØa v√† s·ª≠ d·ª•ng to√†n b·ªô kh√¥ng gian m√†n h√¨nh */
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* B·∫Øt ƒë·∫ßu t·ª´ tr√™n xu·ªëng */
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
        }

        .chess-container {
            background-color: #fff;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 15px; /* Gi·∫£m padding cho mobile */
            max-width: 95vw;
            width: 450px; /* Chi·ªÅu r·ªông t·ªëi ƒëa */
        }

        .board {
            display: grid;
            /* B√†n c·ªù C·ªù T∆∞·ªõng c√≥ 9 c·ªôt v√† 10 h√†ng */
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(10, 1fr);
            width: 100%;
            aspect-ratio: 9 / 10; /* Gi·ªØ t·ª∑ l·ªá chu·∫©n 9x10 */
            background: #d4a373; /* M√†u g·ªó nh·∫°t */
            border: 5px solid #6f4c3b;
            box-sizing: border-box;
            position: relative;
        }

        .square {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            cursor: pointer;
            z-index: 10;
        }
        
        /* V·∫Ω c√°c ƒë∆∞·ªùng k·∫ª ngang v√† d·ªçc */
        .square:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 1px solid #6f4c3b;
            box-sizing: border-box;
            z-index: -1;
        }

        /* X√≥a ƒë∆∞·ªùng k·∫ª b√™n trong, ch·ªâ gi·ªØ l·∫°i ƒë∆∞·ªùng k·∫ª √¥ */
        .square:not(:nth-child(9n)):before { border-right: none; }
        .square:nth-child(n+1):nth-child(-n+9):before { border-top: none; }
        .square:nth-last-child(n+1):nth-last-child(-n+9):before { border-bottom: none; }
        .square:nth-child(9n):before { border-right: none; }
        
        /* X√≥a ƒë∆∞·ªùng k·∫ª gi·ªØa s√¥ng */
        .square:nth-child(n + 37):nth-child( -n + 45):before { border-bottom: none; } /* H√†ng 4 */
        .square:nth-child(n + 46):nth-child( -n + 54):before { border-top: none; } /* H√†ng 5 */

        /* Hi·ªÉn th·ªã S√¥ng (River) */
        .river {
            position: absolute;
            top: 45%;
            left: 0;
            width: 100%;
            height: 10%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5vmin; /* D√πng vmin ƒë·ªÉ co gi√£n theo m√†n h√¨nh */
            font-weight: bold;
            color: #6f4c3b;
            background-color: #f7e0c4;
            pointer-events: none;
            z-index: 5;
            text-shadow: 1px 1px 1px #fff;
        }
        .river-text {
            /* V·ªã tr√≠ c·ªßa H√† */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4vmin; /* D√πng vmin ƒë·ªÉ co gi√£n theo m√†n h√¨nh */
            color: #6f4c3b;
            z-index: 10;
        }

        /* Qu√¢n c·ªù */
        .piece {
            width: 90%; /* TƒÉng k√≠ch th∆∞·ªõc qu√¢n c·ªù cho d·ªÖ ch·∫°m */
            height: 90%;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 5vmin; /* D√πng vmin ƒë·ªÉ co gi√£n theo m√†n h√¨nh */
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s;
        }

        .red {
            background-color: #fce8e8;
            color: #c0392b;
            border: 2px solid #c0392b;
        }

        .black {
            background-color: #e8e8f2;
            color: #2c3e50;
            border: 2px solid #2c3e50;
        }

        /* Tr·∫°ng th√°i */
        .selected {
            transform: scale(1.15); /* TƒÉng scale khi ch·ªçn cho d·ªÖ nh√¨n tr√™n mobile */
            box-shadow: 0 0 10px 4px #f39c12;
            z-index: 20;
        }

        .highlight-move {
            border: 4px dashed #27ae60;
            background-color: rgba(39, 174, 96, 0.2);
        }
        
        /* CSS cho Modal (thay th·∫ø cho alert) */
        #message-modal {
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            visibility: hidden;
        }
        #message-modal.active {
            opacity: 1;
            visibility: visible;
        }
        /* Style cho ƒë·ªãa ch·ªâ v√≠ c√≥ th·ªÉ copy */
        .wallet-address-copy {
            cursor: pointer;
            position: relative;
        }
        .wallet-address-copy:hover .copy-icon {
            opacity: 1;
        }
        .copy-icon {
            opacity: 0.5;
            transition: opacity 0.2s;
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <div class="chess-container">
        
        <div class="flex justify-end w-full mb-3">
            <select id="language-select" class="p-1 border border-gray-300 rounded text-sm bg-white shadow-sm">
                <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
                <option value="en">üá∫üá∏ English</option>
                <option value="zh">üá®üá≥ ‰∏≠Êñá (Simplified)</option>
            </select>
        </div>
        <div class="text-center mb-4">
            <h1 class="text-xl sm:text-2xl font-bold text-gray-800" data-i18n="gameTitle">C·ªù T∆∞·ªõng 2D</h1>
            <p id="status" class="text-sm sm:text-lg font-semibold mt-2 rounded-lg py-1 px-3 inline-block bg-yellow-100 text-yellow-700 shadow-md"></p>
        </div>

        <div class="board" id="board">
            <div class="river"><span class="river-text" data-i18n="riverName">S√¥ng H√†</span></div>
        </div>

        <div class="mt-4 flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4 w-full">
            <button id="reset-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-300 text-base" data-i18n="resetButton">
                Ch∆°i L·∫°i
            </button>
            <button id="donate-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-300 text-base" data-i18n="donateButton">
                ·ª¶ng h·ªô 1 Pi
            </button>
        </div>
        
        <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-xs w-full">
                <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800" data-i18n="modalTitle">Th√¥ng b√°o</h3>
                <div id="modal-content" class="text-gray-700 mb-4 text-sm break-words overflow-y-auto max-h-64"></div>
                <button id="modal-custom-action" class="hidden w-full text-white font-bold py-2 px-4 rounded-lg transition duration-200 mb-3"></button>
                <button id="modal-close" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200" data-i18n="closeButton">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <script>
        // ----------------------------------------------------
        // C·∫•u h√¨nh & Kh·ªüi t·∫°o
        // ----------------------------------------------------
        
        // **ƒê·ªäA CH·ªà V√ç C·ª¶A B·∫†N (S·ª¨A L·∫†I ƒê·ªäA CH·ªà N√ÄY)**
        const PI_WALLET_ADDRESS = 'GBML46SIXNWSYMDJNHPA5CJ4LT65EBJF66HZ26VFPQ3R64EKB7EGYC2P';
        
        const boardElement = document.getElementById('board');
        const statusElement = document.getElementById('status');
        const resetButton = document.getElementById('reset-button');
        const donateButton = document.getElementById('donate-button');
        const languageSelect = document.getElementById('language-select');

        const modalElement = document.getElementById('message-modal');
        const modalTitleElement = document.getElementById('modal-title');
        const modalContentElement = document.getElementById('modal-content');
        const modalCloseButton = document.getElementById('modal-close');
        const modalCustomButton = document.getElementById('modal-custom-action'); 
        
        const BOARD_SIZE = 90; // 9 c·ªôt x 10 h√†ng

        // D·ªØ li·ªáu ng√¥n ng·ªØ (TH√äM M·ªöI)
        const translations = {
            'vi': {
                gameTitle: 'C·ªù T∆∞·ªõng 2D',
                riverName: 'S√¥ng H√†',
                resetButton: 'Ch∆°i L·∫°i',
                donateButton: '·ª¶ng h·ªô 1 Pi',
                modalTitle: 'Th√¥ng b√°o',
                closeButton: 'ƒê√≥ng',
                // Tr·∫°ng th√°i game
                statusRedTurn: 'L∆∞·ª£t c·ªßa ƒê·ªè (Ng∆∞·ªùi ch∆°i)',
                statusBlackTurn: 'L∆∞·ª£t c·ªßa ƒêen (M√°y t√≠nh)',
                winRed: 'ƒê·ªè (Ng∆∞·ªùi ch∆°i)',
                winBlack: 'ƒêen (M√°y t√≠nh)',
                winMessage: (winner) => `${winner} ƒë√£ th·∫Øng! Nh·∫•n Ch∆°i L·∫°i.`,
                drawMessage: 'H√≤a c·ªù. M√°y t√≠nh kh√¥ng c√≤n n∆∞·ªõc ƒëi.',
                // Modal ·ªßng h·ªô
                donateTitle: '·ª¶ng h·ªô Nh√† ph√°t tri·ªÉn',
                donateContent: (address) => `
                    <p class="mb-3">
                        ƒê·ªÉ ·ªßng h·ªô <b>1 Pi</b>, vui l√≤ng th·ª±c hi·ªán th·ªß c√¥ng c√°c b∆∞·ªõc sau:
                    </p>
                    <ol class="list-decimal list-inside space-y-2 text-left px-2">
                        <li>Nh·∫•n v√†o ƒë·ªãa ch·ªâ v√≠ ƒë·ªÉ <b>sao ch√©p</b>.</li>
                        <li>M·ªü Pi Wallet v√† d√°n ƒë·ªãa ch·ªâ ƒë√£ sao ch√©p.</li>
                        <li>Nh·∫≠p s·ªë l∆∞·ª£ng: <b>1 Pi</b>.</li>
                        <li>Nh·∫≠p Ghi ch√∫ (Memo): <b>·ª¶ng h·ªô game C·ªù T∆∞·ªõng</b> (T√πy ch·ªçn).</li>
                    </ol>
                    <p class="mt-4 mb-2 text-sm font-semibold">
                        ƒê·ªãa ch·ªâ V√≠ nh·∫≠n Pi (Nh·∫•p ƒë·ªÉ Sao ch√©p):
                    </p>
                    <div id="wallet-copy-area" 
                         class="wallet-address-copy bg-gray-100 p-3 rounded-lg text-xs font-mono break-all font-semibold text-green-700 hover:bg-gray-200 transition duration-150">
                        ${address}
                        <span class="copy-icon">üìã</span>
                    </div>
                `,
                donateButtonAction: 'M·ªü Pi Wallet (wallet.pinet.com)',
                copySuccess: 'ƒê√£ sao ch√©p! ‚úÖ',
            },
            'en': {
                gameTitle: 'Chinese Chess 2D',
                riverName: 'River (Chu River & Han Border)',
                resetButton: 'Reset Game',
                donateButton: 'Donate 1 Pi',
                modalTitle: 'Notification',
                closeButton: 'Close',
                // Game status
                statusRedTurn: "Red's Turn (Player)",
                statusBlackTurn: "Black's Turn (AI)",
                winRed: 'Red (Player)',
                winBlack: 'Black (AI)',
                winMessage: (winner) => `${winner} wins! Click Reset Game.`,
                drawMessage: 'Draw. AI has no legal moves.',
                // Donate Modal
                donateTitle: 'Support the Developer',
                donateContent: (address) => `
                    <p class="mb-3">
                        To donate <b>1 Pi</b>, please follow these steps manually:
                    </p>
                    <ol class="list-decimal list-inside space-y-2 text-left px-2">
                        <li>Click the wallet address to <b>copy</b>.</li>
                        <li>Open Pi Wallet and paste the copied address.</li>
                        <li>Enter amount: <b>1 Pi</b>.</li>
                        <li>Enter Memo: <b>XianQi Game Support</b> (Optional).</li>
                    </ol>
                    <p class="mt-4 mb-2 text-sm font-semibold">
                        Recipient Pi Wallet Address (Click to Copy):
                    </p>
                    <div id="wallet-copy-area" 
                         class="wallet-address-copy bg-gray-100 p-3 rounded-lg text-xs font-mono break-all font-semibold text-green-700 hover:bg-gray-200 transition duration-150">
                        ${address}
                        <span class="copy-icon">üìã</span>
                    </div>
                `,
                donateButtonAction: 'Open Pi Wallet (wallet.pinet.com)',
                copySuccess: 'Copied! ‚úÖ',
            },
            'zh': {
                gameTitle: 'Ë±°Ê£ã 2D',
                riverName: 'Ê•öÊ≤≥Ê±âÁïå',
                resetButton: 'ÈáçÊñ∞ÂºÄÂßã',
                donateButton: 'ÊçêËµ† 1 Pi',
                modalTitle: 'ÈÄöÁü•',
                closeButton: 'ÂÖ≥Èó≠',
                // Game status
                statusRedTurn: 'Á∫¢ÊñπÂõûÂêà (Áé©ÂÆ∂)',
                statusBlackTurn: 'ÈªëÊñπÂõûÂêà (ÁîµËÑë)',
                winRed: 'Á∫¢Êñπ (Áé©ÂÆ∂)',
                winBlack: 'ÈªëÊñπ (ÁîµËÑë)',
                winMessage: (winner) => `${winner} Ëé∑ËÉú! ËØ∑ÁÇπÂáªÈáçÊñ∞ÂºÄÂßã„ÄÇ`,
                drawMessage: 'ÂíåÂ±Ä„ÄÇÁîµËÑëÊó†ÂêàÊ≥ïÊ£ãÊ≠•„ÄÇ',
                // Donate Modal
                donateTitle: 'ÊîØÊåÅÂºÄÂèëËÄÖ',
                donateContent: (address) => `
                    <p class="mb-3">
                        Ë¶ÅÊçêËµ† <b>1 Pi</b>, ËØ∑ÊâãÂä®ÈÅµÂæ™‰ª•‰∏ãÊ≠•È™§:
                    </p>
                    <ol class="list-decimal list-inside space-y-2 text-left px-2">
                        <li>ÁÇπÂáªÈí±ÂåÖÂú∞ÂùÄ‰ª•<b>Â§çÂà∂</b>„ÄÇ</li>
                        <li>ÊâìÂºÄ Pi Èí±ÂåÖÂπ∂Á≤òË¥¥Âú∞ÂùÄ„ÄÇ</li>
                        <li>ËæìÂÖ•Êï∞Èáè: <b>1 Pi</b>„ÄÇ</li>
                        <li>ËæìÂÖ•Â§áÊ≥®: <b>Ë±°Ê£ãÊ∏∏ÊàèÊîØÊåÅ</b> (ÂèØÈÄâ)„ÄÇ</li>
                    </ol>
                    <p class="mt-4 mb-2 text-sm font-semibold">
                        Êî∂Ê¨æ Pi Èí±ÂåÖÂú∞ÂùÄ (ÁÇπÂáªÂ§çÂà∂):
                    </p>
                    <div id="wallet-copy-area" 
                         class="wallet-address-copy bg-gray-100 p-3 rounded-lg text-xs font-mono break-all font-semibold text-green-700 hover:bg-gray-200 transition duration-150">
                        ${address}
                        <span class="copy-icon">üìã</span>
                    </div>
                `,
                donateButtonAction: 'ÊâìÂºÄ Pi Èí±ÂåÖ (wallet.pinet.com)',
                copySuccess: 'Â∑≤Â§çÂà∂! ‚úÖ',
            }
        };

        // Bi·∫øn ng√¥n ng·ªØ hi·ªán t·∫°i
        let currentLang = localStorage.getItem('lang') || 'vi'; 
        languageSelect.value = currentLang;

        // H√†m d·ªãch thu·∫≠t (TH√äM M·ªöI)
        const t = (key) => {
            const translation = translations[currentLang];
            if (translation && translation[key]) {
                return translation[key];
            }
            // Fallback v·ªÅ ti·∫øng Vi·ªát n·∫øu kh√¥ng t√¨m th·∫•y key
            return translations['vi'][key] || key; 
        };
        
        // H√†m √°p d·ª•ng ng√¥n ng·ªØ (TH√äM M·ªöI)
        const applyLanguage = (lang) => {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            
            // 1. D·ªãch c√°c ph·∫ßn t·ª≠ c√≥ data-i18n
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (key) {
                    element.textContent = t(key);
                }
            });

            // 2. C·∫≠p nh·∫≠t tr·∫°ng th√°i game (v√¨ n√≥ kh√¥ng d√πng data-i18n)
            // C·∫ßn ch·∫°y l·∫°i switchTurn ho·∫∑c initializeGame
            if (currentPlayer === 'red') {
                updateStatus(t('statusRedTurn'), 'bg-red-100 text-red-700');
            } else {
                updateStatus(t('statusBlackTurn'), 'bg-gray-100 text-gray-700');
            }

            // 3. C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ trang
            document.title = t('gameTitle');
        };

        // G·∫Øn s·ª± ki·ªán thay ƒë·ªïi ng√¥n ng·ªØ (TH√äM M·ªöI)
        languageSelect.addEventListener('change', (e) => {
            applyLanguage(e.target.value);
        });

        const INITIAL_BOARD = [
            // ƒêen (Top)
            { piece: 'Xe', color: 'black', pos: 0 }, { piece: 'M√£', color: 'black', pos: 1 }, { piece: 'T∆∞·ª£ng', color: 'black', pos: 2 }, { piece: 'Sƒ©', color: 'black', pos: 3 }, { piece: 'T∆∞·ªõng', color: 'black', pos: 4 }, { piece: 'Sƒ©', color: 'black', pos: 5 }, { piece: 'T∆∞·ª£ng', color: 'black', pos: 6 }, { piece: 'M√£', color: 'black', pos: 7 }, { piece: 'Xe', color: 'black', pos: 8 },
            { piece: null, pos: 9 }, { piece: null, pos: 10 }, { piece: null, pos: 11 }, { piece: null, pos: 12 }, { piece: null, pos: 13 }, { piece: null, pos: 14 }, { piece: null, pos: 15 }, { piece: null, pos: 16 }, { piece: null, pos: 17 },
            { piece: null, pos: 18 }, { piece: 'Ph√°o', color: 'black', pos: 19 }, { piece: null, pos: 20 }, { piece: null, pos: 21 }, { piece: null, pos: 22 }, { piece: null, pos: 23 }, { piece: null, pos: 24 }, { piece: 'Ph√°o', color: 'black', pos: 25 }, { piece: null, pos: 26 },
            { piece: 'T·ªët', color: 'black', pos: 27 }, { piece: null, pos: 28 }, { piece: 'T·ªët', color: 'black', pos: 29 }, { piece: null, pos: 30 }, { piece: 'T·ªët', color: 'black', pos: 31 }, { piece: null, pos: 32 }, { piece: 'T·ªët', color: 'black', pos: 33 }, { piece: null, pos: 34 }, { piece: 'T·ªët', color: 'black', pos: 35 },
            // S√¥ng (36 -> 53)
            // H√†ng tr·ªëng (36 -> 44)
            // H√†ng tr·ªëng (45 -> 53)
            
            // ƒê·ªè (Bottom) - B·∫Øt ƒë·∫ßu t·ª´ 54
            { piece: 'T·ªët', color: 'red', pos: 54 }, { piece: null, pos: 55 }, { piece: 'T·ªët', color: 'red', pos: 56 }, { piece: null, pos: 57 }, { piece: 'T·ªët', color: 'red', pos: 58 }, { piece: null, pos: 59 }, { piece: 'T·ªët', color: 'red', pos: 60 }, { piece: null, pos: 61 }, { piece: 'T·ªët', color: 'red', pos: 62 },
            { piece: null, pos: 63 }, { piece: null, pos: 64 }, { piece: null, pos: 65 }, { piece: null, pos: 66 }, { piece: null, pos: 67 }, { piece: null, pos: 68 }, { piece: null, pos: 69 }, { piece: null, pos: 70 }, { piece: null, pos: 71 },
            { piece: null, pos: 72 }, { piece: 'Ph√°o', color: 'red', pos: 73 }, { piece: null, pos: 74 }, { piece: null, pos: 75 }, { piece: null, pos: 76 }, { piece: null, pos: 77 }, { piece: null, pos: 78 }, { piece: 'Ph√°o', color: 'red', pos: 79 }, { piece: null, pos: 80 },
            { piece: 'Xe', color: 'red', pos: 81 }, { piece: 'M√£', color: 'red', pos: 82 }, { piece: 'T∆∞·ª£ng', color: 'red', pos: 83 }, { piece: 'Sƒ©', color: 'red', pos: 84 }, { piece: 'T∆∞·ªõng', color: 'red', pos: 85 }, { piece: 'Sƒ©', color: 'red', pos: 86 }, { piece: 'T∆∞·ª£ng', color: 'red', pos: 87 }, { piece: 'M√£', color: 'red', pos: 88 }, { piece: 'Xe', color: 'red', pos: 89 }
        ].filter(p => p.piece !== null);
        
        const PIECE_NAMES = {
            // ƒêen (Truy·ªÅn th·ªëng)
            'T∆∞·ªõng': 'Â∞á', 'Sƒ©': 'Â£´', 'T∆∞·ª£ng': 'Ë±°', 'Xe': 'Ëªä', 'M√£': 'È¶¨', 'Ph√°o': 'ÁÇÆ', 'T·ªët': 'Âçí', 
            // ƒê·ªè (Hi·ªán ƒë·∫°i)
            'red': { 'T∆∞·ªõng': 'Â∏•', 'Sƒ©': '‰ªï', 'T∆∞·ª£ng': 'Áõ∏', 'Xe': '‰ø•', 'M√£': 'ÂÇå', 'Ph√°o': 'Á†≤', 'T·ªët': 'ÂÖµ' } 
        };
        
        let boardState = [];
        let selectedPiece = null;
        let currentPlayer = 'red';
        let isAITurn = false; // Bi·∫øn c·ªù ki·ªÉm so√°t l∆∞·ª£t AI
        
        // ----------------------------------------------------
        // H√†m Utility
        // ----------------------------------------------------
        
        // H√†m copy vƒÉn b·∫£n
        const copyToClipboard = (text) => {
            navigator.clipboard.writeText(text).then(() => {
                // Hi·ªÉn th·ªã th√¥ng b√°o nh·ªè tr√™n n√∫t t√πy ch·ªânh
                const targetButton = modalCustomButton.classList.contains('hidden') ? modalCloseButton : modalCustomButton;
                const originalContent = targetButton.textContent;
                const originalClass = targetButton.className;

                targetButton.textContent = t('copySuccess');
                targetButton.classList.remove('bg-indigo-500', 'bg-blue-500');
                targetButton.classList.add('bg-green-600');
                
                setTimeout(() => {
                    targetButton.textContent = originalContent;
                    targetButton.className = originalClass;
                }, 1500);
            }).catch(err => {
                console.error('Kh√¥ng th·ªÉ sao ch√©p', err);
            });
        };

        // Hi·ªÉn th·ªã th√¥ng b√°o b·∫±ng Modal t√πy ch·ªânh (thay th·∫ø cho alert)
        const displayMessage = (title, content, customButton) => {
            modalTitleElement.textContent = title;
            modalContentElement.innerHTML = content;
            modalElement.classList.add('active');
            modalElement.style.display = 'flex';
            
            // X√≥a s·ª± ki·ªán c≈©
            modalCustomButton.onclick = null; 
            modalCustomButton.classList.add('hidden');

            if (customButton) {
                modalCustomButton.textContent = customButton.text;
                modalCustomButton.onclick = customButton.action;
                modalCustomButton.classList.remove('hidden');
                modalCustomButton.classList.add('bg-indigo-500', 'hover:bg-indigo-600');
                modalCustomButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            } else {
                modalCloseButton.classList.add('bg-blue-500', 'hover:bg-blue-600');
                modalCloseButton.classList.remove('bg-indigo-500', 'hover:bg-indigo-600');
            }
        };

        modalCloseButton.addEventListener('click', () => {
            modalElement.classList.remove('active');
            setTimeout(() => modalElement.style.display = 'none', 300);
        });

        // Chuy·ªÉn ƒë·ªïi ch·ªâ s·ªë 1D sang t·ªça ƒë·ªô (row, col)
        const toCoords = (pos) => ({ row: Math.floor(pos / 9), col: pos % 9 });
        // Chuy·ªÉn ƒë·ªïi t·ªça ƒë·ªô (row, col) sang ch·ªâ s·ªë 1D
        const toPos = (row, col) => row * 9 + col;
        
        // L·∫•y qu√¢n c·ªù t·∫°i v·ªã tr√≠
        const getPieceAt = (pos) => boardState.find(p => p.pos === pos);

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i tr√≤ ch∆°i tr√™n UI (S·ª¨A ƒê·ªîI)
        const updateStatus = (message, colorClass) => {
            statusElement.textContent = message;
            statusElement.className = `text-sm sm:text-lg font-semibold mt-2 rounded-lg py-1 px-3 inline-block shadow-md ${colorClass}`;
        }
        
        // Hi·ªÉn th·ªã th√¥ng b√°o chi·∫øn th·∫Øng (S·ª¨A ƒê·ªîI)
        const showWinMessage = (winner) => {
            const winnerName = winner === 'red' ? t('winRed') : t('winBlack');
            const message = t('winMessage')(winnerName);
            updateStatus(message, winner === 'red' ? 'bg-red-200 text-red-800' : 'bg-gray-700 text-white');
            // V√¥ hi·ªáu h√≥a t∆∞∆°ng t√°c
            selectedPiece = true; 
        }

        // ƒê·ªïi l∆∞·ª£t ch∆°i v√† ki·ªÉm tra n·∫øu l√† l∆∞·ª£t AI (S·ª¨A ƒê·ªîI)
        const switchTurn = () => {
            currentPlayer = currentPlayer === 'red' ? 'black' : 'red';
            const statusMessage = currentPlayer === 'red' ? t('statusRedTurn') : t('statusBlackTurn');
            const colorClass = currentPlayer === 'red' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700';
            updateStatus(statusMessage, colorClass);
            
            // N·∫øu l√† l∆∞·ª£t c·ªßa AI
            if (currentPlayer === 'black') {
                isAITurn = true;
                setTimeout(aiMove, 500); // T·∫°o ƒë·ªô tr·ªÖ 500ms ƒë·ªÉ AI "suy nghƒ©"
            }
        }

        // ----------------------------------------------------
        // Logic Ki·ªÉm tra Lu·∫≠t C·ªù
        // ----------------------------------------------------

        // Ki·ªÉm tra xem v·ªã tr√≠ c√≥ n·∫±m trong Cung (Palace) hay kh√¥ng
        const isInPalace = (row, col, color) => {
            const inPalaceCol = col >= 3 && col <= 5;
            if (color === 'red') {
                return inPalaceCol && row >= 7 && row <= 9; // ƒê·ªè: h√†ng 7, 8, 9
            } else {
                return inPalaceCol && row >= 0 && row <= 2; // ƒêen: h√†ng 0, 1, 2
            }
        };

        // Ki·ªÉm tra xem qu√¢n T·ªët ƒë√£ qua s√¥ng hay ch∆∞a
        const isPastRiver = (row, color) => {
            if (color === 'red') {
                return row <= 4; // ƒê·ªè qua s√¥ng khi ƒëi v√†o h√†ng 4 tr·ªü l√™n
            } else {
                return row >= 5; // ƒêen qua s√¥ng khi ƒëi v√†o h√†ng 5 tr·ªü xu·ªëng
            }
        };

        // H√†m ki·ªÉm tra n∆∞·ªõc ƒëi cho XE (Rook)
        const checkLine = (dR, dC, moves, enemyColor, startR, startC) => {
            for (let i = 1; ; i++) {
                const nextR = startR + dR * i;
                const nextC = startC + dC * i;
                const nextPos = toPos(nextR, nextC);
                if (nextR < 0 || nextR >= 10 || nextC < 0 || nextC >= 9) break;

                const targetPiece = getPieceAt(nextPos);
                if (targetPiece) {
                    if (targetPiece.color === enemyColor) {
                        moves.push(nextPos); // B·∫Øt qu√¢n ƒë·ªãch
                    }
                    break; // B·ªã ch·∫∑n
                }
                moves.push(nextPos); // ƒêi v√†o √¥ tr·ªëng
            }
        };
        
        // H√†m ki·ªÉm tra n∆∞·ªõc ƒëi cho PH√ÅO (Cannon)
        const checkCannonLine = (dR, dC, moves, enemyColor, startR, startC) => {
            let screenFound = false; // Bi·∫øn c·ªù cho "Ng√≤i" (Screen/Pivot)
            for (let i = 1; ; i++) {
                const nextR = startR + dR * i;
                const nextC = startC + dC * i;
                const nextPos = toPos(nextR, nextC);
                if (nextR < 0 || nextR >= 10 || nextC < 0 || nextC >= 9) break;

                const targetPiece = getPieceAt(nextPos);
                
                if (!targetPiece) {
                    // √î tr·ªëng
                    if (!screenFound) {
                        moves.push(nextPos); // Di chuy·ªÉn th√¥ng th∆∞·ªùng (tr∆∞·ªõc khi t√¨m th·∫•y ng√≤i)
                    }
                } else {
                    // G·∫∑p m·ªôt qu√¢n c·ªù
                    if (!screenFound) {
                        screenFound = true; // ƒê√¢y l√† NG√íI (qu√¢n ch·∫Øn ƒë·∫ßu ti√™n)
                    } else {
                        // G·∫∑p qu√¢n c·ªù th·ª© hai (sau ng√≤i)
                        if (targetPiece.color === enemyColor) {
                            moves.push(nextPos); // B·∫Øt qu√¢n ƒë·ªãch (qua ng√≤i)
                        }
                        break; // D√π b·∫Øt hay kh√¥ng, b·ªã ch·∫∑n b·ªüi qu√¢n c·ªù th·ª© hai
                    }
                }
            }
        };

        // T√¨m t·∫•t c·∫£ c√°c n∆∞·ªõc ƒëi h·ª£p l·ªá cho qu√¢n c·ªù (ch∆∞a bao g·ªìm lu·∫≠t chi·∫øu t∆∞·ªõng)
        const getValidMoves = (piece) => {
            const { row: startR, col: startC } = toCoords(piece.pos);
            const moves = [];
            const color = piece.color;
            const enemyColor = color === 'red' ? 'black' : 'red';

            switch (piece.piece) {
                case 'T∆∞·ªõng':
                    [[1, 0], [-1, 0], [0, 1], [0, -1]].forEach(([dr, dc]) => {
                        const nextR = startR + dr;
                        const nextC = startC + dc;
                        const nextPos = toPos(nextR, nextC);
                        const targetPiece = getPieceAt(nextPos);

                        if (nextR >= 0 && nextR < 10 && nextC >= 0 && nextC < 9 && isInPalace(nextR, nextC, color)) {
                            if (!targetPiece || targetPiece.color === enemyColor) {
                                moves.push(nextPos);
                            }
                        }
                    });
                    break;
                case 'Sƒ©':
                    // ƒêi ch√©o 1 √¥, ph·∫£i ·ªü trong Cung
                    [[1, 1], [1, -1], [-1, 1], [-1, -1]].forEach(([dr, dc]) => {
                        const nextR = startR + dr;
                        const nextC = startC + dc;
                        const nextPos = toPos(nextR, nextC);
                        const targetPiece = getPieceAt(nextPos);

                        if (nextR >= 0 && nextR < 10 && nextC >= 0 && nextC < 9 && isInPalace(nextR, nextC, color)) {
                            if (!targetPiece || targetPiece.color === enemyColor) {
                                moves.push(nextPos);
                            }
                        }
                    });
                    break;
                case 'T∆∞·ª£ng':
                    // ƒêi ch√©o 2 √¥, kh√¥ng ƒë∆∞·ª£c b·ªã c·∫£n ·ªü √¥ gi·ªØa (ch√¢n T∆∞·ª£ng)
                    [[2, 2], [2, -2], [-2, 2], [-2, -2]].forEach(([dr, dc]) => {
                        const nextR = startR + dr;
                        const nextC = startC + dc;
                        const nextPos = toPos(nextR, nextC);
                        const targetPiece = getPieceAt(nextPos);
                        
                        const midR = startR + dr / 2;
                        const midC = startC + dc / 2;
                        const midPos = toPos(midR, midC);

                        // Ph·∫£i n·∫±m trong gi·ªõi h·∫°n v√† KH√îNG ƒë∆∞·ª£c qua s√¥ng
                        if (nextR >= 0 && nextR < 10 && nextC >= 0 && nextC < 9 && (color === 'red' ? nextR >= 5 : nextR <= 4)) {
                            // Ki·ªÉm tra ch√¢n t∆∞·ª£ng
                            if (!getPieceAt(midPos) && (!targetPiece || targetPiece.color === enemyColor)) {
                                moves.push(nextPos);
                            }
                        }
                    });
                    break;
                case 'Xe':
                    [[1, 0], [-1, 0], [0, 1], [0, -1]].forEach(([dr, dc]) => checkLine(dr, dc, moves, enemyColor, startR, startC));
                    break;
                case 'Ph√°o':
                    [[1, 0], [-1, 0], [0, 1], [0, -1]].forEach(([dr, dc]) => checkCannonLine(dr, dc, moves, enemyColor, startR, startC));
                    break;
                case 'M√£':
                    // ƒêi L 2-1, kh√¥ng ƒë∆∞·ª£c b·ªã c·∫£n ·ªü √¥ li·ªÅn k·ªÅ (ch√¢n M√£)
                    [[2, 1], [2, -1], [-2, 1], [-2, -1], [1, 2], [1, -2], [-1, 2], [-1, -2]].forEach(([dr, dc]) => {
                        const nextR = startR + dr;
                        const nextC = startC + dc;
                        const nextPos = toPos(nextR, nextC);
                        const targetPiece = getPieceAt(nextPos);

                        if (nextR >= 0 && nextR < 10 && nextC >= 0 && nextC < 9) {
                            // X√°c ƒë·ªãnh ch√¢n M√£ (√¥ li·ªÅn k·ªÅ)
                            const midR = startR + (Math.abs(dr) > 1 ? Math.sign(dr) : 0);
                            const midC = startC + (Math.abs(dc) > 1 ? Math.sign(dc) : 0);
                            const midPos = toPos(midR, midC);
                            
                            // Ki·ªÉm tra ch√¢n M√£
                            if (!getPieceAt(midPos) && (!targetPiece || targetPiece.color === enemyColor)) {
                                moves.push(nextPos);
                            }
                        }
                    });
                    break;
                case 'T·ªët':
                    let possibleMoves = [];
                    if (color === 'red') {
                        possibleMoves.push([-1, 0]); // Lu√¥n ti·∫øn l√™n
                        if (isPastRiver(startR, color)) {
                            possibleMoves.push([0, 1], [0, -1]); // Qua s√¥ng ƒë∆∞·ª£c ƒëi ngang
                        }
                    } else { // black
                        possibleMoves.push([1, 0]); // Lu√¥n ti·∫øn xu·ªëng
                        if (isPastRiver(startR, color)) {
                            possibleMoves.push([0, 1], [0, -1]); // Qua s√¥ng ƒë∆∞·ª£c ƒëi ngang
                        }
                    }

                    possibleMoves.forEach(([dr, dc]) => {
                        const nextR = startR + dr;
                        const nextC = startC + dc;
                        const nextPos = toPos(nextR, nextC);
                        const targetPiece = getPieceAt(nextPos);

                        if (nextR >= 0 && nextR < 10 && nextC >= 0 && nextC < 9) {
                            if (!targetPiece || targetPiece.color === enemyColor) {
                                moves.push(nextPos);
                            }
                        }
                    });
                    break;
            }

            return moves;
        };

        // ----------------------------------------------------
        // Logic AI ƒêen (M√°y t√≠nh) - ƒê√£ C·∫£i Ti·∫øn
        // ----------------------------------------------------

        const aiMove = () => {
            if (currentPlayer !== 'black') return;

            isAITurn = true; 
            
            // 1. Thu th·∫≠p t·∫•t c·∫£ n∆∞·ªõc ƒëi h·ª£p l·ªá v√† ph√¢n lo·∫°i
            let allLegalMoves = [];
            let capturingMoves = []; 
            let generalCaptureMoves = []; // N∆∞·ªõc ƒëi b·∫Øt T∆∞·ªõng (th·∫Øng ngay)

            const blackPieces = boardState.filter(p => p.color === 'black');

            for (const piece of blackPieces) {
                const moves = getValidMoves(piece);
                if (moves.length > 0) {
                    moves.forEach(move => {
                        const moveData = { piece, targetPos: move };
                        allLegalMoves.push(moveData);
                        
                        const targetPiece = getPieceAt(move);
                        if (targetPiece) {
                            if (targetPiece.piece === 'T∆∞·ªõng') {
                                generalCaptureMoves.push(moveData); // N∆∞·ªõc ƒëi b·∫Øt T∆∞·ªõng
                            }
                            capturingMoves.push(moveData); // N∆∞·ªõc ƒëi b·∫Øt qu√¢n n√≥i chung
                        }
                    });
                }
            }
            
            // 2. Ch·ªçn b·ªô n∆∞·ªõc ƒëi theo ∆∞u ti√™n
            let moveSet = [];
            if (generalCaptureMoves.length > 0) {
                moveSet = generalCaptureMoves; // ∆Øu ti√™n 1: Th·∫Øng ngay (B·∫Øt T∆∞·ªõng)
            } else if (capturingMoves.length > 0) {
                moveSet = capturingMoves; // ∆Øu ti√™n 2: B·∫Øt qu√¢n kh√°c
            } else {
                moveSet = allLegalMoves; // ∆Øu ti√™n 3: ƒêi ng·∫´u nhi√™n
            }
            
            if (moveSet.length === 0) {
                updateStatus(t('drawMessage'), 'bg-yellow-200 text-yellow-800');
                isAITurn = false;
                selectedPiece = true; 
                return;
            }

            // 3. Ch·ªçn ng·∫´u nhi√™n m·ªôt n∆∞·ªõc ƒëi t·ª´ b·ªô ∆∞u ti√™n
            const randomIndex = Math.floor(Math.random() * moveSet.length);
            const { piece: pieceToMove, targetPos } = moveSet[randomIndex];

            // 4. Th·ª±c hi·ªán n∆∞·ªõc ƒëi
            const capturedPiece = getPieceAt(targetPos);
            
            // N·∫øu ƒÉn ƒë∆∞·ª£c T∆∞·ªõng, AI th·∫Øng
            if (capturedPiece && capturedPiece.piece === 'T∆∞·ªõng') {
                boardState = boardState.filter(p => p.pos !== targetPos); 
                pieceToMove.pos = targetPos; 
                boardState = boardState.filter(p => p !== pieceToMove);
                boardState.push(pieceToMove);

                renderBoard();
                showWinMessage('black');
                isAITurn = false;
                return;
            }

            // Di chuy·ªÉn/ƒÇn qu√¢n (kh√¥ng ph·∫£i T∆∞·ªõng)
            boardState = boardState.filter(p => p.pos !== targetPos && p !== pieceToMove);
            pieceToMove.pos = targetPos;
            boardState.push(pieceToMove);

            isAITurn = false;
            selectedPiece = null;
            renderBoard();
            switchTurn();
        };


        // ----------------------------------------------------
        // Logic ·ª¶ng h·ªô (Chuy·ªÉn sang V√≠ Pi) (S·ª¨A ƒê·ªîI)
        // ----------------------------------------------------

        const initiatePiPayment = () => {
            const content = t('donateContent')(PI_WALLET_ADDRESS);
            
            const customButton = {
                text: t('donateButtonAction'),
                action: () => {
                    // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn Pi Wallet
                    window.open('https://wallet.pinet.com/', '_blank');
                    // T·ª± ƒë·ªông ƒë√≥ng modal
                    modalCloseButton.click(); 
                }
            };

            // Hi·ªÉn th·ªã modal h∆∞·ªõng d·∫´n v√† n√∫t M·ªü V√≠
            displayMessage(t('donateTitle'), content, customButton);
            
            // G·∫Øn s·ª± ki·ªán copy sau khi modal ƒë∆∞·ª£c hi·ªÉn th·ªã 
            setTimeout(() => {
                const copyArea = document.getElementById('wallet-copy-area');
                if (copyArea) {
                    copyArea.onclick = () => {
                        copyToClipboard(PI_WALLET_ADDRESS);
                        // C·∫≠p nh·∫≠t bi·ªÉu t∆∞·ª£ng/n·ªôi dung nh·ªè khi copy th√†nh c√¥ng
                        copyArea.querySelector('.copy-icon').textContent = '‚úÖ';
                        setTimeout(() => {
                            copyArea.querySelector('.copy-icon').textContent = 'üìã';
                        }, 1500);
                    };
                }
            }, 100); 
        };


        // ----------------------------------------------------
        // X·ª≠ l√Ω Giao di·ªán v√† S·ª± ki·ªán
        // ----------------------------------------------------

        // H√†m v·∫Ω l·∫°i to√†n b·ªô b√†n c·ªù
        const renderBoard = () => {
            // X√≥a c√°c √¥ c≈© (tr·ª´ S√¥ng)
            boardElement.querySelectorAll('.square').forEach(sq => sq.remove());
            
            // Th√™m l·∫°i c√°c √¥ c·ªù (Squares)
            for (let i = 0; i < BOARD_SIZE; i++) {
                const square = document.createElement('div');
                square.className = 'square';
                square.dataset.pos = i;
                square.addEventListener('click', handleSquareClick);
                
                const pieceData = getPieceAt(i);
                if (pieceData) {
                    const pieceElement = document.createElement('div');
                    const pieceName = pieceData.color === 'red' 
                        ? PIECE_NAMES.red[pieceData.piece] 
                        : PIECE_NAMES[pieceData.piece];
                    
                    pieceElement.textContent = pieceName;
                    pieceElement.className = `piece ${pieceData.color}`;
                    pieceElement.dataset.piece = pieceData.piece;
                    pieceElement.dataset.color = pieceData.color;
                    
                    square.appendChild(pieceElement);
                    
                    if (selectedPiece && selectedPiece.pos === i) {
                        pieceElement.classList.add('selected');
                    }
                }
                
                boardElement.appendChild(square);
            }

            if (selectedPiece && !isAITurn) {
                const validMoves = getValidMoves(selectedPiece);
                validMoves.forEach(pos => {
                    const square = boardElement.querySelector(`[data-pos="${pos}"]`);
                    if (square) {
                        square.classList.add('highlight-move');
                    }
                });
            }
            
            // ƒê·∫£m b·∫£o S√¥ng lu√¥n n·∫±m tr√™n c√πng (ƒë·ªÉ kh√¥ng b·ªã ƒë√® l√™n qu√¢n c·ªù)
            const river = boardElement.querySelector('.river');
            if (river) boardElement.appendChild(river);
        };

        // X·ª≠ l√Ω khi click v√†o √¥ c·ªù
        const handleSquareClick = (event) => {
            if (currentPlayer !== 'red' || isAITurn || selectedPiece === true) return;
            
            const squareElement = event.currentTarget;
            const pos = parseInt(squareElement.dataset.pos);
            const pieceAtPos = getPieceAt(pos);

            // 1. N·∫øu ch∆∞a c√≥ qu√¢n n√†o ƒë∆∞·ª£c ch·ªçn
            if (!selectedPiece) {
                if (pieceAtPos && pieceAtPos.color === currentPlayer) {
                    selectedPiece = pieceAtPos;
                    renderBoard(); 
                }
                return;
            }

            const validMoves = getValidMoves(selectedPiece);
            
            // 2. N·∫øu ƒë√£ ch·ªçn qu√¢n, nh∆∞ng click v√†o qu√¢n c√πng m√†u
            if (pieceAtPos && pieceAtPos.color === currentPlayer) {
                selectedPiece = pieceAtPos; 
                renderBoard();
                return;
            }

            // 3. N·∫øu click v√†o √¥ h·ª£p l·ªá (di chuy·ªÉn ho·∫∑c ƒÉn)
            if (validMoves.includes(pos)) {
                
                // N·∫øu ƒÉn T∆∞·ªõng, ng∆∞·ªùi ch∆°i th·∫Øng ngay
                if (pieceAtPos && pieceAtPos.piece === 'T∆∞·ªõng') {
                    boardState = boardState.filter(p => p.pos !== pos); 
                    selectedPiece.pos = pos;
                    
                    boardState = boardState.filter(p => p !== selectedPiece);
                    boardState.push(selectedPiece);
                    
                    renderBoard();
                    showWinMessage(currentPlayer);
                    return;
                }

                // Di chuy·ªÉn/ƒÇn qu√¢n (kh√¥ng ph·∫£i T∆∞·ªõng)
                boardState = boardState.filter(p => p.pos !== pos && p !== selectedPiece);
                selectedPiece.pos = pos;
                boardState.push(selectedPiece);
                
                // K·∫øt th√∫c l∆∞·ª£t ng∆∞·ªùi ch∆°i v√† chuy·ªÉn sang l∆∞·ª£t AI
                selectedPiece = null;
                renderBoard();
                switchTurn();

            } else {
                // Click v√†o √¥ kh√¥ng h·ª£p l·ªá, h·ªßy ch·ªçn
                selectedPiece = null;
                renderBoard();
            }
        };

        // Kh·ªüi t·∫°o tr·∫°ng th√°i tr√≤ ch∆°i (S·ª¨A ƒê·ªîI)
        const initializeGame = () => {
            // Sao ch√©p s√¢u m·∫£ng ban ƒë·∫ßu
            boardState = INITIAL_BOARD.map(p => ({ ...p }));
            selectedPiece = null;
            currentPlayer = 'red';
            isAITurn = false;
            
            // C·∫≠p nh·∫≠t ng√¥n ng·ªØ v√† tr·∫°ng th√°i
            applyLanguage(currentLang);
            updateStatus(t('statusRedTurn'), 'bg-red-100 text-red-700');
            renderBoard();
        };

        // G·∫Øn s·ª± ki·ªán cho n√∫t ch∆°i l·∫°i v√† n√∫t ·ªßng h·ªô
        resetButton.addEventListener('click', initializeGame);
        donateButton.addEventListener('click', initiatePiPayment);

        // Ch·∫°y l·∫ßn ƒë·∫ßu
        window.onload = initializeGame;

    </script>
</body>
</html>
